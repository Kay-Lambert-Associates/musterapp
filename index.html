<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>Unity WebGL Player | Muster</title>
    <link rel="shortcut icon" href="TemplateData/favicon.ico">
    <link rel="stylesheet" href="TemplateData/style.css">
    <script src="TemplateData/UnityProgress.js"></script>
    <script src="Build/UnityLoader.js"></script>
    <script>
      var unityInstance = UnityLoader.instantiate("unityContainer", "Build/client-prod.json", {onProgress: UnityProgress});
    </script>
    <script>var gameInstance = unityInstance;</script>
</head>
  <body>
    <div class="webgl-content">
      <div id="unityContainer" style="width: 960px; height: 600px"></div>
      <div class="footer">
        <div class="webgl-logo"></div>
        <div class="fullscreen" onclick="unityInstance.SetFullscreen(1)"></div>
        <div class="title">Muster</div>
      </div>
    </div>
  
    <form id="fileBrowserPopup" style="display: none">
        <div class="fileBrowserBackground"></div>
        <div class="fileBrowserContainer">
        <span style="font-size: 4em; color: #00e2b0">
            <i class="icon fas fa-file-upload"></i>
        </span>
        <span class="fileBrowserText">Click below to open file browser</span>

        <div>
            <label for="closePopup">
            <a class="button6 button-grey">Close</a>
            </label>
            <input
            type="button"
            name="closePopup"
            id="closePopup"
            style="display: none"
            onclick="requestCloseFileBrowserForOpen();"
            />
            <label for="fileToUpload">
            <a class="button6 button-green bouncy">Select</a>
            </label>
            <input
            type="File"
            name="fileToUpload"
            id="fileToUpload"
            onchange="fbLoadFiles(event.target.files);return false;"
            />
        </div>
        </div>
    </form>

    <script type='text/javascript'>
        function callFBFunctionByName(functionName, parameter){
            switch(functionName){
                case "initializeFBLibrary":
                    initializeFBLibrary();
                    break;
                case "openFileBrowserForLoad":
                    openFileBrowserForLoad(parameter);
                    break;
                case "cleanupFB":
                    cleanupFB();
                    break;       
                case "closeFileBrowserForOpen":
                    closeFileBrowserForOpen();
                    break;
                case "saveFile":
                    saveFileFB(parameter);
                    break;
                case "setLocalization":
                    setLocalizationFB(parameter);
                    break;
            }
        }
        document.callFBFunctionByName = callFBFunctionByName;

        function initializeFBLibrary(){
            document.fbPopup = document.getElementById("fileBrowserPopup");
            document.fbOpenFilePopupInput = document.getElementById("fileToUpload");

            document.fbStorage = { 
                initialized: true,
                loadedFiles: {},
                dataPointers: []
            };
        }

        function openFileBrowserForLoad(parameters){
            if(document.fbStorage.initialized !== true)
                return;

            var typesFilter = parameters[0];
            var isMultipleSelection = parameters[1] === 1 ? true : false;

            if(document.fbOpenFilePopupInput.hasAttribute('multiple'))
                document.fbOpenFilePopupInput.removeAttribute('multiple');

            if(isMultipleSelection){
                document.fbOpenFilePopupInput.setAttribute('multiple', '');
            }

            document.fbOpenFilePopupInput.accept = typesFilter;
		    document.fbPopup.style.display = "flex";
        }

        function closeFileBrowserForOpen(){
            if(document.fbStorage.initialized !== true)
                return;
            document.fbPopup.style.display = "none";
        }

        function cleanupFB() {
            if(document.fbStorage.initialized !== true)
                return;
            document.fbStorage.loadedFiles = {};
            document.fbStorage.dataPointers = [];
        }

        function saveFileFB(fileData){
            if(document.fbStorage.initialized !== true)
                return;

            let fileInfo = {
                status: true,
                message: "",
                name: fileData.name
            };

            try{
                var contentType = 'application/octet-stream';
                var a = document.createElement('a');
                var blob = new Blob([fbBase64ToBytesArray(fileData.data)], {
                    'type': contentType
                });
                a.href = window.URL.createObjectURL(blob);
                a.download = fileData.name;

                if (document.createEvent) {
                    var event = document.createEvent('MouseEvents');
                    event.initEvent('click', true, true);
                    a.dispatchEvent(event);
                } else {
                    a.click();
                }

                gameInstance.SendMessage(libraryHandlerObjectName, "HandleFileSaved", JSON.stringify(fileInfo));
            }
            catch(ex){
                fileInfo.status = false;
                fileInfo.message = ex.message;

                gameInstance.SendMessage(libraryHandlerObjectName, "HandleFileSaved", JSON.stringify(fileInfo));
            }
        }

        const libraryHandlerObjectName = "[FGFileBrowser]";

        function fbLoadFiles(files) {
            gameInstance.SendMessage(libraryHandlerObjectName, 'SetAmountOfFilesToBeLoaded', files.length);

            for (var i = 0, f; f = files[i]; i++) {
                var reader = new FileReader();
                reader.onload = (function (file) {
                    return function (fileloadEvent) {
                        let loadedFileInfo = fileloadEvent.target.result;
                
                        document.fbStorage.loadedFiles[file.name] = {
                            info: loadedFileInfo
                        };

                        let extensionSplit = file.name.split('.');
                        let extension = extensionSplit[extensionSplit.length - 1];
                        let name = file.name.replace(extension, "");
                        name = name.substring(0, name.length - 1);

                        let loadedFile = {
                            fullName: file.name,
                            name: name,
                            path: "unavailable-in-web",
                            length: loadedFileInfo.byteLength,
                            size: file.size,
                            extension: extension
                        };

                        gameInstance.SendMessage(libraryHandlerObjectName, 'HandleLoadedFile', JSON.stringify(loadedFile));
                    }
                })(f);
                
                reader.readAsArrayBuffer(f);
            }
			document.fbOpenFilePopupInput.value = "";
        }

        function requestCloseFileBrowserForOpen() {
            gameInstance.SendMessage(libraryHandlerObjectName, "CloseFileBrowserForOpen");
        }

        function fbBase64ToBytesArray(base64) {
            var binary_string = window.atob(base64);
            var len = binary_string.length;
            var bytes = new Uint8Array(len);
            for (var i = 0; i < len; i++) {
                bytes[i] = binary_string.charCodeAt(i);
            }
            return bytes.buffer;
        }

        function setLocalizationFB(parameter){
            switch(parameter.key){
                case "HEADER_TITLE":
                    document.getElementById("fb_popup_header_title").innerHTML = parameter.value;
                    break;
                case "DESCRIPTION_TEXT":
                    document.getElementById("fb_popup_description_title").innerHTML = parameter.value;
                    break;
                case "SELECT_BUTTON_CONTENT":
                    document.getElementById("fb_popup_select_button_title").innerHTML = parameter.value;
                    break;
                case "CLOSE_BUTTON_CONTENT":
                    document.getElementById("fb_popup_close_button_title").innerHTML = parameter.value;
                    break;
            }
        }

    </script>
    <!-- END WEBGL FILE BROWSER LIB -->
</body>
</html>
